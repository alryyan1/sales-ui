# دليل اختبار وحدة: إدارة المبيعات

## الهدف
التحقق من قدرة المستخدمين على تسجيل عمليات بيع جديدة للعملاء بنجاح، وتحديث كميات المخزون (من الدُفعات المحددة) بشكل صحيح، وتسجيل تفاصيل الدفعات المتعددة، وحساب الإجماليات والمبالغ المستحقة.

---

## المتطلبات الأساسية للمُختبِر
1. الوصول إلى النظام.
2. بيانات اعتماد مستخدم بصلاحيات مناسبة (مثل `view-sales`, `create-sales`, وربما `edit-sales` إذا كانت محدودة).
3. وجود عملاء ومنتجات (مع مخزون ودُفعات متعددة إذا أمكن، وبتواريخ انتهاء صلاحية مختلفة) مُنشأة مسبقًا.

---

## حالات الاختبار

### 1. إنشاء فاتورة بيع جديدة (/sales/add أو SaleFormPage.tsx)

#### TES1.1: فتح نموذج إضافة فاتورة بيع
- **الإجراء**: انتقل إلى قسم "المبيعات" وانقر على زر "إضافة عملية بيع جديدة".
- **النتيجة المتوقعة**: يتم فتح صفحة أو نافذة نموذج إضافة فاتورة بيع تحتوي على الحقول الرئيسية (العميل، تاريخ البيع، الحالة، رقم الفاتورة (اختياري)، الملاحظات) وقسم لإضافة بنود المنتجات وقسم للمدفوعات.

#### TES1.2: إضافة فاتورة بيع ناجحة - جميع الحقول المطلوبة صالحة
- **الإجراء**:
  1. اختر عميلاً موجودًا.
  2. حدد تاريخ البيع.
  3. اختر الحالة (مثال: "مكتملة").
  4. أضف بند منتج واحد على الأقل:
      - اختر منتجًا.
      - اختر دُفعة (Batch) إذا كان المنتج لديه دُفعات متعددة.
      - أدخل الكمية المباعة (لا تتجاوز الكمية المتبقية في الدُفعة المختارة).
      - أدخل سعر الوحدة (قابل للتعديل).
  5. (اختياري) أضف المزيد من بنود المنتجات.
  6. في قسم المدفوعات:
      - أضف طريقة دفع واحدة على الأقل (مثال: "نقدي") وأدخل المبلغ المدفوع.
      - (اختياري) أضف طريقة دفع أخرى.
  7. انقر "حفظ".
- **النتيجة المتوقعة**:
  - تظهر رسالة نجاح "تم حفظ عملية البيع بنجاح".
  - يتم تحديث المخزون بشكل صحيح:
    - `purchase_items.remaining_quantity` للدُفعات المستخدمة ينقص بمقدار الكميات المباعة.
    - `products.stock_quantity` ينقص بشكل صحيح.

#### TES1.3: إضافة فاتورة بيع - الحقول المطلوبة في الترويسة مفقودة
- **الإجراء**: حاول الحفظ بدون اختيار عميل أو تاريخ بيع.
- **النتيجة المتوقعة**: تظهر رسائل خطأ تحقق بجانب الحقول المطلوبة. لا يتم إنشاء الفاتورة.

#### TES1.4: إضافة فاتورة بيع - عدم إضافة أي بنود منتجات
- **الإجراء**: املأ حقول الترويسة ولكن لا تضف أي بند منتج. حاول الحفظ.
- **النتيجة المتوقعة**: تظهر رسالة خطأ "يجب إضافة منتج واحد على الأقل". لا يتم إنشاء الفاتورة.

#### TES1.5: إضافة فاتورة بيع - بيانات غير صالحة في بنود المنتجات
- **الإجراء**:
  1. أضف بند منتج.
  2. اترك حقل "المنتج" أو "الدُفعة" فارغًا، أو أدخل كمية "0" أو سالبة.
  3. حاول الحفظ.
- **النتيجة المتوقعة**: تظهر رسائل خطأ تحقق بجانب الحقول غير الصالحة. لا يتم إنشاء الفاتورة.

#### TES1.6: إضافة فاتورة بيع - كمية مباعة تتجاوز المخزون المتاح في الدُفعة
- **الإجراء**: اختر منتجًا ودُفعة وأدخل كمية أكبر من `remaining_quantity`.
- **النتيجة المتوقعة**: تظهر رسالة خطأ "لا توجد كمية كافية في الدُفعة". لا يتم إنشاء الفاتورة.

#### TES1.7: إضافة فاتورة بيع - كمية مباعة تتجاوز إجمالي مخزون المنتج
- **الإجراء**: اختر منتجًا وأدخل كمية أكبر من إجمالي مخزونه المتاح.
- **النتيجة المتوقعة**: تظهر رسالة خطأ "المخزون غير كافٍ". لا يتم إنشاء الفاتورة.

#### TES1.8: اختبار المدفوعات
- **الإجراء**:
  1. أدخل مبلغًا في طريقة دفع واحدة أقل من الإجمالي.
  2. تحقق من "المبلغ المستحق". أضف طريقة دفع أخرى وادفع الجزء المتبقي.
  3. حاول إدخال "إجمالي مدفوع" أكبر من "المبلغ الإجمالي".
- **النتيجة المتوقعة**:
  - يتم حساب "الإجمالي المدفوع" و"المبلغ المستحق" بشكل صحيح.
  - لا يُسمح بمبالغ مدفوعة أكثر من الإجمالي.

#### TES1.9: التحقق من حساب المجموع الكلي للفاتورة والمبلغ المستحق
- **الإجراء**: أضف عدة بنود منتجات بكميات وأسعار مختلفة، وادفع جزءًا من المبلغ.
- **النتيجة المتوقعة**: يتم حساب "المجموع الكلي"، "الإجمالي المدفوع"، و"المبلغ المستحق" بشكل صحيح.

#### TES1.10: إلغاء عملية إضافة فاتورة بيع
- **الإجراء**: املأ بعض البيانات ثم انقر "إلغاء".
- **النتيجة المتوقعة**: لا يتم إنشاء أي سجلات.

---

### 2. عرض قائمة المبيعات (/sales أو SalesListPage.tsx)

#### TES2.1: الوصول إلى صفحة قائمة المبيعات
- **الإجراء**: انتقل إلى قسم "المبيعات".
- **النتيجة المتوقعة**: يتم تحميل قائمة بالفواتير المسجلة (التاريخ، رقم الفاتورة، العميل، الحالة، الإجمالي، المدفوع، المستحق).

#### TES2.2: اختبار ترقيم الصفحات والبحث والتصفية
- **الإجراء**: استخدم عناصر التحكم (البحث أو تصفية الفواتير حسب الحالة).
- **النتيجة المتوقعة**: تعمل بشكل صحيح.

---

### 3. عرض تفاصيل فاتورة بيع (/sales/:id أو SaleDetailsPage.tsx)

#### TES3.1: الوصول إلى صفحة تفاصيل الفاتورة
- **الإجراء**: من قائمة المبيعات، انقر على "عرض" أو رقم مرجعي لفتح تفاصيل الفاتورة.
- **النتيجة المتوقعة**:
  - يتم عرض معلومات الترويسة.
  - يتم عرض جدولي بنود المنتجات والمدفوعات.
  - يتم عرض المجموع الكلي، "الإجمالي المدفوع"، و"المبلغ المستحق".

#### TES3.2: زر "إضافة دفعة" (إذا كان المبلغ المستحق > 0)
- **الإجراء**: انقر على زر "إضافة دفعة".
- **النتيجة المتوقعة**: فتح نموذج لإضافة دفعة جديدة للفاتورة.

#### TES3.3: زر "إنشاء مرتجع" (إذا كانت الفاتورة مكتملة)
- **الإجراء**: انقر على زر "إنشاء مرتجع".
- **النتيجة المتوقعة**: يتم توجيه المستخدم إلى صفحة إنشاء مرتجع مبيعات مع ملء معرّف الفاتورة الأصلية.

---

### 4. تعديل فاتورة بيع (إذا تم تطبيقه - عادةً ما يكون محدودًا جدًا)

#### TES4.1: تعديل الحقول المسموح بها
- **الإجراء**: إذا كان هناك زر "تعديل"، انقر عليه وقم بتعديل الحقول المسموح بها (مثل الملاحظات).
- **النتيجة المتوقعة**: يتم حفظ التغييرات وتحديث السجل.

---

### 5. الصلاحيات

#### TES5.1: اختبار الوصول بناءً على صلاحيات المستخدم
- **الإجراء**: تحقق من الوصول وإنشاء وتعديل فواتير البيع بناءً على الصلاحيات (مثل `view-sales`, `create-sales`).
- **النتيجة المتوقعة**: يتم التحكم في الوصول بناءً على الصلاحيات.

---

## ملاحظات إضافية
- بعد الانتهاء من هذه الاختبارات، ستكون وحدة المبيعات قد تم التحقق منها بشكل جيد.
- الوحدة التالية المقترحة للاختبار بعد ذلك ستكون **وحدة مرتجعات المبيعات (Sales Returns)**.
